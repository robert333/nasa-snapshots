<html>
<head>
	<meta charset='UTF-8'>
	<title>NASA Terra/Aqua MODIS Snapshots</title>
	<style>
		.snapshots-input {
			display: grid;
			grid-template-columns: 200px 200px 200px 200px;
			grid-gap: 6px;
		}
		.snapshots-input-group {
			display: grid;
			grid-template-columns: 60px 100px;
		}
		.snapshots-request {
			padding-top: 20px;
			padding-bottom: 25px;
		}
		td {
			padding: 5px;
		}
	</style>
</head>
<body>
	<h2>NASA Terra/Aqua MODIS Snapshots</h2>

	<p>
		<div>
			<a href='https://wvs.earthdata.nasa.gov/'>NASA Snapshots</a>
		</div>
	
		<div>
			<a href='https://worldview.earthdata.nasa.gov/'>NASA Worldview</a>
		</div>
	
		<div>
			<a href='https://earth.esa.int/web/guest/missions/3rd-party-missions/current-missions/terraaqua-modis'>Terra/Aqua MODIS Information</a>
		</div>
	</p>

	<div class='snapshots-input'>
		<h4>Date Range</h4>
		<h4>Longitude</h4>
		<h4>Latitude</h4>
		<h4>Image</h4>

		<div class='snapshots-input-group'>
			<label for="start_date">start:</label>
			<input id='start_date' type='text' value='2020-01-07'>
		</div>
		<div class='snapshots-input-group'>
			<label for="longitude_min">min:</label>
			<input id='longitude_min' type='text' value='-60'>
		</div>
		<div class='snapshots-input-group'>
			<label for="latitude_min">min:</label>
			<input id='latitude_min' type='text' value='6'>
		</div>
		<div class='snapshots-input-group'>
			<label for="image_width">width:</label>
			<input id='image_width' type='text' value='500'>
		</div>

		<div class='snapshots-input-group'>
			<label for="end_date">end:</label>
			<input id='end_date' type='text' value='2020-01-12'>
		</div>
		<div class='snapshots-input-group'>
			<label for="longitude_max">max:</label>
			<input id='longitude_max' type='text' value='-50.0'>
		</div>
		<div class='snapshots-input-group'>
			<label for="latitude_max">max:</label>
			<input id='latitude_max' type='text' value='16.0'>
		</div>
		<div class='snapshots-input-group'>
			<div></div>
			<div>
				<input type="checkbox" id="image_overlay" checked>
  				<label for="image_overlay">overlay</label>
			</div>
		</div>

		<div class='snapshots-request'>
			<button onclick='request_snapshots()'>Request</button>
		</div>
	</div>

	<p>
		<table id='nasa_snapshot_table'>
			<thead>
				<tr>
					<th>Date</th>
					<th>Terra (MODIS)</th>
					<th>Aqua (MODIS)</th>
				</tr>
			</thead>
			<tbody>
			</tbody>
		</table>
	</p>
	
	<script src='https://d3js.org/d3.v5.min.js'></script>
	<script src='https://momentjs.com/downloads/moment.min.js'></script>

	<script>
		function request_snapshots() {
			const start_date_str = document.getElementById('start_date').value
			const end_date_str = document.getElementById('end_date').value

			const start_date = moment(start_date_str)
			const end_date = moment(end_date_str).add(1, 'days')
			
			const time_format = d3.timeFormat('%Y-%m-%d')
		
			const tbody = d3.select('#nasa_snapshot_table').select('tbody')

			tbody.selectAll('tr').remove()

			tbody.selectAll('tr')
				.data(d3.timeDay.range(start_date.toDate(), end_date.toDate()))
				.enter()
				.each(d => {
					const tr = tbody.append('tr')
					tr.append('td').text(time_format(d))
					add_nasa_snapshot(tr.append('td'), 'Terra', time_format(d))
					add_nasa_snapshot(tr.append('td'), 'Aqua', time_format(d))
				})
		}
		
		function add_nasa_snapshot(table_cell, satellite, time) {
			const latitude_min = parseFloat(document.getElementById('latitude_min').value)
			const latitude_max = parseFloat(document.getElementById('latitude_max').value)
			const longitude_min = parseFloat(document.getElementById('longitude_min').value)
			const longitude_max = parseFloat(document.getElementById('longitude_max').value)
			const show_image_overlay = document.getElementById('image_overlay').checked

			const scale_factor = (longitude_max - longitude_min) / (latitude_max - latitude_min)

			const width = parseInt(document.getElementById('image_width').value)
			const height = Math.round(width / scale_factor)

			const bbox_str = String(latitude_min)
			+ ',' + String(longitude_min)
			+ ',' + String(latitude_max)
			+ ',' + String(longitude_max)

			const v_str = String(longitude_min)
			+ ',' + String(latitude_min)
			+ ',' + String(longitude_max)
			+ ',' + String(latitude_max)

			console.log(bbox_str, v_str, scale_factor, width, height)

			const layers = 'MODIS_' + satellite + '_CorrectedReflectance_TrueColor'
			
			const worldview_link = table_cell.append('a')
				.attr('href', 'https://worldview.earthdata.nasa.gov/?p=geographic&l=' + layers + '&t=' + time + '&v=' + v_str)
				.attr('target', '_blank')
				.attr('rel', 'noopener noreferrer')
			
			const container = worldview_link.append('div')
				.style('position', 'relative')
			
			const worldview_image = container.append('img')
				.attr('src', 'https://wvs.earthdata.nasa.gov/api/v1/snapshot?REQUEST=GetSnapshot&LAYERS=' + layers + '&CRS=EPSG:4326&TIME=' + time + '&WRAP=DAY&BBOX=' + bbox_str + '&FORMAT=image/png&WIDTH=' + String(width) + '&HEIGHT=' + String(height) + '&AUTOSCALE=TRUE')
				.style('z-index', -1)
				.style('position', 'absolute')
				.style('left', '0px')
				.style('top', '0px')
			
			const worldview_canvas = container.append('canvas')
				.attr('width', width)
				.attr('height', height)

			const context = worldview_canvas.node().getContext('2d')

			function get_pos(lon, lat) {
				const x = (lon - longitude_min) / (longitude_max - longitude_min) * width
				const y = (latitude_max - lat) / (latitude_max - latitude_min) * height
				return [x, y]
			}

			function draw_line(lon_a, lat_a, lon_b, lat_b) {
				const pos_a = get_pos(lon_a, lat_a)
				const pos_b = get_pos(lon_b, lat_b)
				console.log(pos_a, pos_b)
				context.beginPath()
				context.moveTo(pos_a[0], pos_a[1])
				context.lineTo(pos_b[0], pos_b[1])
				context.lineWidth = 1
				context.strokeStyle = '#ff0000'//'#00ff00'
				context.stroke()
			}

			function draw_circle(lon, lat) {
				const pos = get_pos(lon, lat)
				const size = 1 / (longitude_max - longitude_min) * width
				context.beginPath()
				context.arc(pos[0], pos[1], size, 0, 2 * Math.PI, false)
				context.lineWidth = 1
				context.strokeStyle = '#ff0000'//'#00ff00'
				context.stroke()
			}

			if (show_image_overlay) {
				draw_line(-57, 12, -57, 14.5)
				draw_line(-59.43, 13.16, -51.02, 14.82)
				draw_circle(-57.7, 13.3)
				// draw_line(-57.7, 13.3, -56.7, 13.3)
				// draw_line(-57.7, 13.3, -57.7, 12.3)
				draw_line(-59, 10.5, -52, 10.5)
				draw_line(-59, 8.5, -52, 8.5)
			}
		}
	</script>

	<script>
		request_snapshots()
	</script>
</body>
</html>
